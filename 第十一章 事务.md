# 事务

事务是代表单个工作单元的一组 SQL 语句。所有这些语句都应成功完成。否则事务会运行失败

事物的性质：
- Atomicity 原子性。每个事务都是一个工作单元，不管它包含多少语句。要么所有这些语句都成功执行且事物被提交，要么事务被回去所有更改被撤销
- Consistency 一致性。这意味着通过使用事务，数据库将始终保持一致的状态
- Isolation 隔离性。这意味着这些事务相互隔离，或者当有同样的数据被更改时各自受到保护，他们不会相互干扰。如果多个事务想更新相同的数据，受影响的行会被锁定，因此一次只有一个事务可以更新行
- Durability 持久性。事务产生的更改是永久的，即使遇到停电或者系统崩溃，也不会丢失更改的内容

## 创建事务

```sql
USE sql_store;

START TRANSACTION;
-- 第一步
INSERT INTO orders (customer_id, order_date, status)
VALUES (1, '2019-01-01', 1);
-- 第二步
INSERT INTO order_items
VALUES (LAST_INSERT_ID(), 1, 1, 1);

COMMIT;  
```

- 如果第二步运行失败，第一步做的更改会自动取消
- 使用 COMMIT 进行提交；使用 ROLLBACK 进行回滚

## 并发和锁定

其实事务就是对其中 SQL 语句所使用的数据上了一把锁。两个用户执行下述代码，后执行的会等待先执行的执行完毕，才修改数据库内容

```sql
USE sql_store;

START TRANSACTION;

UPDATE customers
SET points = points + 10
WHERE customer_id = 1;

COMMIT;
```

## 并发问题

### 丢失更新

当两个事务尝试更新相同的数据并且没有上锁时，就会发生这种情况。
较晚提交的事务会覆盖较早事务做出的更改



















