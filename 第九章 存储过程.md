# stored procedure 存储过程

个人理解是封装了一个 SQL 函数

创建一个 stored procedure

```sql
DELIMITER $$  -- MySQL 需要使用这样一个新的分隔符
CREATE PROCEDURE get_clients()
BEGIN
	SELECT * FROM clients;
END $$
DELIMITER ;
```

使用 CALL 关键字调用 stored procedure

```sql
CALL get_clients()
```

练习：创建一个 stored procedure：get_invoices_with_balance()

```sql
DELIMITER $$
CREATE PROCEDURE get_invoices_with_balance()
BEGIN
	SELECT *
    FROM invoices_with_balance
    WHERE balance > 0;
END $$
DELIMITER ;
```

## 使用工作台创建

右击 MySQL Workbench 出现 create stored procedure 选项

这块建议看视频

## 删除存储过程

```sql
DROP PROCEDURE get_clients

DROP PROCEDURE  IF EXISTS get_clients
```

## 添加参数

```sql
DROP PROCEDURE IF EXISTS get_clients_by_state;

DELIMITER $$
CREATE PROCEDURE get_clients_by_state(
	state CHAR(2) -- 使用 , 分隔多参数
)
BEGIN 
	SELECT * 
    FROM clients c
    WHERE c.state = state;  -- state 优先指参数 而不是列名
END $$
DELIMITER ;

CALL get_clients_by_state('TX')
```

- 练习

```sql
DROP PROCEDURE IF EXISTS get_invoices_by_client;

DELIMITER $$
CREATE PROCEDURE get_invoices_by_client(
	client_id INT
)
BEGIN 
	SELECT * 
    FROM invoices i
    WHERE i.client_id = client_id; 
END $$
DELIMITER ;

CALL get_invoices_by_client(3)
```

## 添加默认值

方法一

```sql
DROP PROCEDURE IF EXISTS get_clients_by_state;

DELIMITER $$
CREATE PROCEDURE get_clients_by_state(
	state CHAR(2) -- 使用 , 分隔多参数
)
BEGIN 
	IF state IS NULL THEN
		SELECT * FROM clients;
	ELSE
		SELECT * FROM clients c
		WHERE c.state = state;
	END IF;
END $$
DELIMITER ;

call sql_invoicing.get_clients_by_state(NULL);
call sql_invoicing.get_clients_by_state('TX');
```

方法二

```sql
DROP PROCEDURE IF EXISTS get_clients_by_state;

DELIMITER $$
CREATE PROCEDURE get_clients_by_state(
	state CHAR(2) -- 使用 , 分隔多参数
)
BEGIN 
	SELECT * FROM clients c
	WHERE c.state = IFNULL(state, c.state); -- 如果第一个值是 NULL 就返回 第二个值
END $$
DELIMITER ;
```

练习：

```sql
DROP PROCEDURE IF EXISTS get_payments;

DELIMITER $$
CREATE PROCEDURE get_payments (
	client_id INT,
    payment_method_id TINYINT
)
BEGIN 
	SELECT * FROM payments p
	WHERE 
		p.client_id = IFNULL(client_id, p.client_id) AND
        p.payment_method = 
			IFNULL(payment_method_id, p.payment_method);
END $$
DELIMITER ;
```

## 参数验证












